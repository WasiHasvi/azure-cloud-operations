name: Create Azure Key Vault (Manual)

on:
  workflow_dispatch:
    inputs:
      rgName:
        description: "Resource Group name"
        required: true
        type: string
      location:
        description: "Azure region (e.g., eastus, westeurope, centralindia)"
        required: true
        default: "eastus"
        type: string
      keyVaultName:
        description: "Desired Key Vault name (3–24 chars, lowercase/digits/hyphens; start letter; end alphanumeric)"
        required: true
        default: "kv-shared-ops-ci"
        type: string
      sku:
        description: "Key Vault SKU"
        required: true
        default: "standard"
        type: choice
        options: ["standard", "premium"]
      enableRBAC:
        description: "Use RBAC authorization (recommended)"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]
      enablePurgeProtection:
        description: "Enable purge protection (cannot be disabled later)"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]
      publicNetworkAccess:
        description: "Public network access"
        required: true
        default: "Disabled"
        type: choice
        options: ["Disabled", "Enabled"]
      defaultAction:
        description: "Firewall default action (when PNA Enabled)"
        required: true
        default: "Deny"
        type: choice
        options: ["Deny", "Allow"]
      grantSecretsOfficerToThisSP:
        description: "Grant 'Key Vault Secrets Officer' to this workflow's SP"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]

permissions:
  id-token: write
  contents: read

jobs:
  create-kv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure Microsoft.KeyVault provider is registered
        shell: bash
        run: |
          set -euo pipefail
          az provider register -n Microsoft.KeyVault --wait
          az provider show -n Microsoft.KeyVault \
            --query "{namespace:namespace,state:registrationState}" -o table

      - name: Sanitize Key Vault name
        id: sanitizekv
        shell: bash
        run: |
          set -euo pipefail
          raw='${{ github.event.inputs.keyVaultName }}'
          kv=$(printf '%s' "$raw" | tr '[:upper:]' '[:lower:]')
          kv=$(printf '%s' "$kv" | sed 's/[^a-z0-9-]/-/g' | sed 's/-\{2,\}/-/g')
          [[ $kv =~ ^[a-z] ]] || kv="kv-$kv"
          kv=${kv%%-}
          kv=${kv:0:24}
          kv=${kv%%-}
          if ! [[ $kv =~ ^[a-z][a-z0-9-]{1,22}[a-z0-9]$ ]]; then
            echo "::error::Invalid Key Vault name after sanitization: '$raw' → '$kv'."
            exit 1
          fi
          echo "name=$kv" >> "$GITHUB_OUTPUT"
          echo "Using Key Vault name: $kv"

      - name: Ensure Resource Group
        run: |
          az group create \
            --name "${{ github.event.inputs.rgName }}" \
            --location "${{ github.event.inputs.location }}" \
            --tags "owner=${{ github.actor }}" "purpose=key-vault"

      - name: Create/Configure Key Vault
        id: createkv
        shell: bash
        run: |
          RG="${{ github.event.inputs.rgName }}"
          LOC="${{ github.event.inputs.location }}"
          KV="${{ steps.sanitizekv.outputs.name }}"
          SKU="${{ github.event.inputs.sku }}"
          RBAC="${{ github.event.inputs.enableRBAC }}"
          PURGE="${{ github.event.inputs.enablePurgeProtection }}"
          PNA="${{ github.event.inputs.publicNetworkAccess }}"
          DFA="${{ github.event.inputs.defaultAction }}"

          ARGS=( -n "$KV" -g "$RG" -l "$LOC" --sku "$SKU" )
          [[ "$RBAC" == "true" ]] && ARGS+=( --enable-rbac-authorization true )
          [[ "$PURGE" == "true" ]] && ARGS+=( --enable-purge-protection true )

          az keyvault create "${ARGS[@]}"

          az keyvault update -n "$KV" -g "$RG" --public-network-access "$PNA"
          az keyvault update -n "$KV" -g "$RG" --default-action "$DFA"

          KV_ID=$(az keyvault show -n "$KV" -g "$RG" --query id -o tsv)
          echo "kvId=$KV_ID" >> "$GITHUB_OUTPUT"

      - name: Grant 'Key Vault Secrets Officer' to this SP (optional)
        if: ${{ github.event.inputs.grantSecretsOfficerToThisSP == 'true' }}
        shell: bash
        run: |
          KV_ID='${{ steps.createkv.outputs.kvId }}'
          APP_ID='${{ vars.AZURE_CLIENT_ID }}'
          OBJ_ID=$(az ad sp show --id "$APP_ID" --query id -o tsv)
          az role assignment create \
            --assignee-object-id "$OBJ_ID" \
            --assignee-principal-type ServicePrincipal \
            --role "Key Vault Secrets Officer" \
            --scope "$KV_ID" \
            --only-show-errors || true

      - name: Show Key Vault summary
        run: |
          az keyvault show -n "${{ steps.sanitizekv.outputs.name }}" \
            -g "${{ github.event.inputs.rgName }}" -o table
